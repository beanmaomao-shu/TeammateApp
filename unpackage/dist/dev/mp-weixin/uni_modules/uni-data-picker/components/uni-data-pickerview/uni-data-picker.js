"use strict";const f=require("../../../../common/vendor.js"),c={props:{localdata:{type:[Array,Object],default(){return[]}},spaceInfo:{type:Object,default(){return{}}},collection:{type:String,default:""},action:{type:String,default:""},field:{type:String,default:""},orderby:{type:String,default:""},where:{type:[String,Object],default:""},pageData:{type:String,default:"add"},pageCurrent:{type:Number,default:1},pageSize:{type:Number,default:500},getcount:{type:[Boolean,String],default:!1},getone:{type:[Boolean,String],default:!1},gettree:{type:[Boolean,String],default:!1},manual:{type:Boolean,default:!1},value:{type:[Array,String,Number],default(){return[]}},modelValue:{type:[Array,String,Number],default(){return[]}},preload:{type:Boolean,default:!1},stepSearh:{type:Boolean,default:!0},selfField:{type:String,default:""},parentField:{type:String,default:""},multiple:{type:Boolean,default:!1},map:{type:Object,default(){return{text:"text",value:"value"}}}},data(){return{loading:!1,errorMessage:"",loadMore:{contentdown:"",contentrefresh:"",contentnomore:""},dataList:[],selected:[],selectedIndex:0,page:{current:this.pageCurrent,size:this.pageSize,count:0}}},computed:{isLocalData(){return!this.collection.length},isCloudData(){return this.collection.length>0},isCloudDataList(){return this.isCloudData&&!this.parentField&&!this.selfField},isCloudDataTree(){return this.isCloudData&&this.parentField&&this.selfField},dataValue(){return(Array.isArray(this.modelValue)?this.modelValue.length>0:this.modelValue!==null||this.modelValue!==void 0)?this.modelValue:this.value},hasValue(){return typeof this.dataValue=="number"?!0:this.dataValue!=null&&this.dataValue.length>0}},created(){this.$watch(()=>{var e=[];return["pageCurrent","pageSize","spaceInfo","value","modelValue","localdata","collection","action","field","orderby","where","getont","getcount","gettree"].forEach(t=>{e.push(this[t])}),e},(e,t)=>{for(let a=2;a<e.length&&e[a]==t[a];a++);e[0]!=t[0]&&(this.page.current=this.pageCurrent),this.page.size=this.pageSize,this.onPropsChange()}),this._treeData=[]},methods:{onPropsChange(){this._treeData=[]},async loadData(){this.isLocalData?this.loadLocalData():this.isCloudDataList?this.loadCloudDataList():this.isCloudDataTree&&this.loadCloudDataTree()},async loadLocalData(){this._treeData=[],this._extractTree(this.localdata,this._treeData);let e=this.dataValue;e!==void 0&&(Array.isArray(e)&&(e=e[e.length-1],typeof e=="object"&&e[this.map.value]&&(e=e[this.map.value])),this.selected=this._findNodePath(e,this.localdata))},async loadCloudDataList(){if(!this.loading){this.loading=!0;try{let t=(await this.getCommand()).result.data;this._treeData=t,this._updateBindData(),this._updateSelected(),this.onDataChange()}catch(e){this.errorMessage=e}finally{this.loading=!1}}},async loadCloudDataTree(){if(!this.loading){this.loading=!0;try{let e={field:this._cloudDataPostField(),where:this._cloudDataTreeWhere()};this.gettree&&(e.startwith=`${this.selfField}=='${this.dataValue}'`);let a=(await this.getCommand(e)).result.data;this._treeData=a,this._updateBindData(),this._updateSelected(),this.onDataChange()}catch(e){this.errorMessage=e}finally{this.loading=!1}}},async loadCloudDataNode(e){if(!this.loading){this.loading=!0;try{let t={field:this._cloudDataPostField(),where:this._cloudDataNodeWhere()},i=(await this.getCommand(t)).result.data;e(i)}catch(t){this.errorMessage=t}finally{this.loading=!1}}},getCloudDataValue(){if(this.isCloudDataList)return this.getCloudDataListValue();if(this.isCloudDataTree)return this.getCloudDataTreeValue()},getCloudDataListValue(){let e=[],t=this._getForeignKeyByField();return t&&e.push(`${t} == '${this.dataValue}'`),e=e.join(" || "),this.where&&(e=`(${this.where}) && (${e})`),this.getCommand({field:this._cloudDataPostField(),where:e}).then(a=>(this.selected=a.result.data,a.result.data))},getCloudDataTreeValue(){return this.getCommand({field:this._cloudDataPostField(),getTreePath:{startWith:`${this.selfField}=='${this.dataValue}'`}}).then(e=>{let t=[];return this._extractTreePath(e.result.data,t),this.selected=t,t})},getCommand(e={}){let t=f.Vs.database(this.spaceInfo);const a=e.action||this.action;a&&(t=t.action(a));const i=e.collection||this.collection;t=t.collection(i);const l=e.where||this.where;!l||!Object.keys(l).length||(t=t.where(l));const s=e.field||this.field;s&&(t=t.field(s));const r=e.orderby||this.orderby;r&&(t=t.orderBy(r));const n=e.pageCurrent!==void 0?e.pageCurrent:this.page.current,h=e.pageSize!==void 0?e.pageSize:this.page.size,d=e.getcount!==void 0?e.getcount:this.getcount,u=e.gettree!==void 0?e.gettree:this.gettree,o={getCount:d,getTree:u};return e.getTreePath&&(o.getTreePath=e.getTreePath),t=t.skip(h*(n-1)).limit(h).get(o),t},_cloudDataPostField(){let e=[this.field];return this.parentField&&e.push(`${this.parentField} as parent_value`),e.join(",")},_cloudDataTreeWhere(){let e=[],t=this.selected,a=this.parentField;if(a&&e.push(`${a} == null || ${a} == ""`),t.length)for(var i=0;i<t.length-1;i++)e.push(`${a} == '${t[i].value}'`);let l=[];return this.where&&l.push(`(${this.where})`),e.length&&l.push(`(${e.join(" || ")})`),l.join(" && ")},_cloudDataNodeWhere(){let e=[],t=this.selected;return t.length&&e.push(`${this.parentField} == '${t[t.length-1].value}'`),e=e.join(" || "),this.where?`(${this.where}) && (${e})`:e},_getWhereByForeignKey(){let e=[],t=this._getForeignKeyByField();return t&&e.push(`${t} == '${this.dataValue}'`),this.where?`(${this.where}) && (${e.join(" || ")})`:e.join(" || ")},_getForeignKeyByField(){let e=this.field.split(","),t=null;for(let a=0;a<e.length;a++){const i=e[a].split("as");if(!(i.length<2)&&i[1].trim()==="value"){t=i[0].trim();break}}return t},_updateBindData(e){const{dataList:t,hasNodes:a}=this._filterData(this._treeData,this.selected);let i=this._stepSearh===!1&&!a;return e&&(e.isleaf=i),this.dataList=t,this.selectedIndex=t.length-1,!i&&this.selected.length<t.length&&this.selected.push({value:null,text:"请选择"}),{isleaf:i,hasNodes:a}},_updateSelected(){let e=this.dataList,t=this.selected,a=this.map.text,i=this.map.value;for(let l=0;l<t.length;l++){let s=t[l].value,r=e[l];for(let n=0;n<r.length;n++){let h=r[n];if(h[i]===s){t[l].text=h[a];break}}}},_filterData(e,t){let a=[],i=!0;a.push(e.filter(l=>l.parent_value===null||l.parent_value===void 0||l.parent_value===""));for(let l=0;l<t.length;l++){let s=t[l].value,r=e.filter(n=>n.parent_value===s);r.length?a.push(r):i=!1}return{dataList:a,hasNodes:i}},_extractTree(e,t,a){let i=this.map.value;for(let l=0;l<e.length;l++){let s=e[l],r={};for(let h in s)h!=="children"&&(r[h]=s[h]);a!=null&&a!==""&&(r.parent_value=a),t.push(r);let n=s.children;n&&this._extractTree(n,t,s[i])}},_extractTreePath(e,t){for(let a=0;a<e.length;a++){let i=e[a],l={};for(let r in i)r!=="children"&&(l[r]=i[r]);t.push(l);let s=i.children;s&&this._extractTreePath(s,t)}},_findNodePath(e,t,a=[]){let i=this.map.text,l=this.map.value;for(let s=0;s<t.length;s++){let r=t[s],n=r.children,h=r[i],d=r[l];if(a.push({value:d,text:h}),d===e)return a;if(n){const u=this._findNodePath(e,n,a);if(u.length)return u}a.pop()}return[]}}};exports.dataPicker=c;
