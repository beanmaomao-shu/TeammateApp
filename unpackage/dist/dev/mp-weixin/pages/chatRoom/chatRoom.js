"use strict";const e=require("../../common/vendor.js"),b=require("../../common/assets.js"),T=require("../../api/chat.js"),R=require("../../api/userInfo.js");if(!Array){const k=e.resolveComponent("infoCard"),x=e.resolveComponent("uni-icons"),i=e.resolveComponent("transition"),r=e.resolveComponent("uni-popup-dialog"),u=e.resolveComponent("uni-popup");(k+x+i+r+u)()}const j=()=>"../../components/infoCard/infoCard.js",U=()=>"../../uni_modules/uni-icons/components/uni-icons/uni-icons.js",P=()=>"../../uni_modules/uni-popup/components/uni-popup-dialog/uni-popup-dialog.js",q=()=>"../../uni_modules/uni-popup/components/uni-popup/uni-popup.js";Math||(j+U+P+q)();const B={__name:"chatRoom",setup(k){const x=e.ref(0),i=e.ref([{type:1,text:"Hello!",time:"9:32"},{type:2,text:"Hi!",time:"9:33"}]),r=e.ref(""),u=e.ref(!1),w=e.ref(null);e.ref("");let a=!1;const c=e.ref(null),_=e.ref({}),d=e.ref(0),m=e.ref("");e.onLoad(o=>{c.value=o.chatRoomId,C()});const C=async()=>{try{const o=await R.getUserInfoAPI();o&&o.data&&o.data.username?(m.value=o.data.username,e.index.setStorageSync("username",o.data.username),console.log("获取到的用户名:",m.value)):console.error("获取用户信息失败或用户名为空")}catch(o){console.error("获取用户名出错:",o)}};e.onMounted(()=>{console.log("聊天室ID:",c.value),console.log("当前用户名:",m.value),c.value?(M(),W(),y(),v(),z()):e.index.showToast({title:"聊天室ID不存在",icon:"none"})});const D=()=>{u.value=!u.value,u.value&&setTimeout(()=>{f()},300)},M=()=>{_.value={name:"对一题就队",icon:"../../static/images/队伍图标2.jpg"}},W=async()=>{try{if(!c.value)return;const o=await T.getUnreadCount([c.value]);if(o.code===200&&o.data){const s=o.data.find(t=>t.chatRoomId===parseInt(c.value));s&&(d.value=s.count)}}catch(o){console.error("获取未读消息数量失败:",o)}},z=async()=>{try{if(!c.value)return;(await T.markMessagesAsRead(c.value)).code===200&&(d.value=0)}catch(o){console.error("标记消息为已读失败:",o)}};e.onUnmounted(()=>{L()});const y=()=>{try{const o=e.index.getStorageSync("token"),s=`ws://117.72.54.182:8898/chat/${c.value}`;if(a){console.log("WebSocket已连接，无需重新连接");return}e.index.connectSocket({url:s,success:()=>{console.log("WebSocket连接请求发送成功")},fail:t=>{console.error("WebSocket连接请求失败:",t)}}),e.index.onSocketOpen(function(){console.log("WebSocket连接已打开"),a=!0}),e.index.onSocketError(function(t){console.error("WebSocket连接错误:",t),a=!1,e.index.showToast({title:"WebSocket连接失败",icon:"none"}),setTimeout(()=>{a||(console.log("尝试重新连接WebSocket"),y())},5e3)}),e.index.onSocketMessage(function(t){try{const n=JSON.parse(t.data);if(console.log("收到消息:",n),n.messageType){const g=n.messageType==="img";let l="";if(n.sendTime){const h=n.sendTime.match(/\d{2}:\d{2}:\d{2}/);h?l=h[0].substring(0,5):l=new Date().toLocaleTimeString("zh-CN",{hour12:!1}).slice(0,5)}else l=new Date().toLocaleTimeString("zh-CN",{hour12:!1}).slice(0,5);const I=m.value||e.index.getStorageSync("username");console.log("消息判断使用的用户名:",I,"消息中的用户名:",n.username);const S={type:n.username===I?2:1,text:n.content,time:l,isImage:g};i.value.some(h=>h.text===S.text&&h.type===S.type&&h.time===S.time)||(i.value.push(S),f())}}catch(n){console.error("解析消息失败:",n)}}),e.index.onSocketClose(function(){console.log("WebSocket连接已关闭"),a=!1,setTimeout(()=>{a||(console.log("连接已关闭，尝试重新连接"),y())},3e3)}),N()}catch(o){console.error("初始化WebSocket失败:",o)}};let p=null;const N=()=>{p&&clearInterval(p),p=setInterval(()=>{a?(console.log("发送心跳包"),e.index.sendSocketMessage({data:JSON.stringify({type:"heartbeat",chatRoomId:c.value}),fail:o=>{console.error("心跳发送失败:",o),a=!1,clearInterval(p),setTimeout(()=>{y()},1e3)}})):(console.log("WebSocket未连接，尝试重连"),clearInterval(p),y())},3e4)},L=()=>{try{a&&e.index.closeSocket({success:()=>{console.log("WebSocket关闭成功"),a=!1},fail:o=>{console.error("WebSocket关闭失败:",o)},complete:()=>{a=!1,p&&(clearInterval(p),p=null)}})}catch(o){console.error("关闭WebSocket出错:",o)}},v=async()=>{try{const o=await T.getChatMessages(c.value);if(o&&o.code===200&&o.data){i.value=[];const s=m.value||e.index.getStorageSync("username");console.log("历史消息判断使用的用户名:",s),o.data.forEach(t=>{let n="";if(t.sendTime){const l=t.sendTime.match(/\d{2}:\d{2}:\d{2}/);l?n=l[0].substring(0,5):n=new Date(t.timestamp).toLocaleTimeString("zh-CN",{hour12:!1}).slice(0,5)}else n=new Date(t.timestamp).toLocaleTimeString("zh-CN",{hour12:!1}).slice(0,5);const g=t.messageType==="img";i.value.push({type:t.username===s?2:1,text:t.content,time:n,isImage:g})}),f()}}catch(o){console.error("获取历史消息失败:",o),e.index.showToast({title:"获取历史消息失败",icon:"none"})}},f=()=>{setTimeout(()=>{const o=e.index.createSelectorQuery();o.select(".chat-content").boundingClientRect(),o.exec(function(s){s&&s[0]&&e.index.pageScrollTo({scrollTop:s[0].height,duration:300})})},100)},A=()=>{if(r.value.trim()){const o=new Date().toLocaleTimeString("zh-CN",{hour12:!1}).slice(0,5),s={messageType:"text",content:r.value,username:m.value||e.index.getStorageSync("username")};console.log("发送消息:",JSON.stringify(s)),e.index.sendSocketMessage({data:JSON.stringify(s),success:()=>{const t={type:2,text:r.value,time:o,isImage:!1};i.value.push(t),r.value="",f(),setTimeout(()=>{v()},1e3)},fail:t=>{console.error("发送消息失败:",t),e.index.showToast({title:"发送消息失败",icon:"none"})}})}},F=()=>{const o="我的微信是: yangbaba",s=new Date().toLocaleTimeString("zh-CN",{hour12:!1}).slice(0,5),t={messageType:"text",content:o,username:m.value||e.index.getStorageSync("username")};e.index.sendSocketMessage({data:JSON.stringify(t),success:()=>{i.value.push({type:2,text:o,time:s}),f(),setTimeout(()=>{v()},1e3)}})},O=()=>{e.index.chooseImage({count:1,sizeType:["compressed"],sourceType:["album"],success:o=>{const s=o.tempFilePaths[0],t=new Date().toLocaleTimeString("zh-CN",{hour12:!1}).slice(0,5);e.index.showLoading({title:"图片上传中..."}),T.uploadFile(s).then(n=>{if(n.code===200){const g=n.data.url,l={messageType:"img",content:g,username:m.value||e.index.getStorageSync("username")};e.index.sendSocketMessage({data:JSON.stringify(l),success:()=>{i.value.push({type:2,text:g,time:t,isImage:!0}),f(),setTimeout(()=>{v()},1e3)}})}else e.index.showToast({title:"图片上传失败: "+(n.msg||"未知错误"),icon:"none"})}).catch(n=>{console.error("上传图片失败:",n),e.index.showToast({title:"图片上传失败",icon:"none"})}).finally(()=>{e.index.hideLoading()}),u.value=!1}})};return(o,s)=>e.e({a:e.t(_.value.name||"对一题就队"),b:_.value.icon||"../../static/images/队伍图标2.jpg",c:d.value>0},d.value>0?{d:e.t(d.value>99?"99+":d.value)}:{},{e:e.f(i.value,(t,n,g)=>e.e({a:t.type==1},t.type==1?{b:b._imports_1$1,c:e.t(t.text),d:e.t(t.time)}:{},{e:t.type==2},t.type==2?e.e({f:!t.isImage},t.isImage?{i:t.text,j:e.o(l=>o.previewImage(t.text),n),k:e.t(t.time)}:{g:e.t(t.text),h:e.t(t.time)},{l:b._imports_0$1}):{},{m:n})),f:u.value?1:"",g:x.value,h:e.o((...t)=>o.onScrollToLower&&o.onScrollToLower(...t)),i:e.o([t=>r.value=t.detail.value,(...t)=>o.handleInput&&o.handleInput(...t)]),j:r.value,k:e.o(D),l:!r.value,m:e.p({type:"plus",size:"40"}),n:r.value,o:e.o(A),p:e.p({type:"image",size:"40"}),q:e.o(O),r:e.p({type:"camera",size:"40"}),s:e.p({type:"email",size:"40"}),t:e.p({type:"phone",size:"40"}),v:e.p({type:"location",size:"40"}),w:e.p({type:"weixin",size:"40"}),x:e.o((...t)=>o.exchangeWechat&&o.exchangeWechat(...t)),y:u.value,z:e.p({name:"slide-up"}),A:u.value?1:"",B:e.o(F),C:e.p({type:"success",cancelText:"取消",confirmText:"确定",content:"您确定要交换联系方式吗?"}),D:e.sr(w,"9b186cfb-9",{k:"isOpen"}),E:e.p({type:"dialog"})})}},E=e._export_sfc(B,[["__scopeId","data-v-9b186cfb"]]);wx.createPage(E);
