"use strict";const e=require("../../common/vendor.js"),C=require("../../common/assets.js"),T=require("../../api/chat.js"),O=require("../../api/userInfo.js");if(!Array){const b=e.resolveComponent("infoCard"),w=e.resolveComponent("uni-icons"),i=e.resolveComponent("transition"),r=e.resolveComponent("uni-popup-dialog"),u=e.resolveComponent("uni-popup");(b+w+i+r+u)()}const R=()=>"../../components/infoCard/infoCard.js",P=()=>"../../uni_modules/uni-icons/components/uni-icons/uni-icons.js",U=()=>"../../uni_modules/uni-popup/components/uni-popup-dialog/uni-popup-dialog.js",j=()=>"../../uni_modules/uni-popup/components/uni-popup/uni-popup.js";Math||(R+P+U+j)();const E={__name:"chatRoom",setup(b){const w=e.ref(0),i=e.ref([{type:1,text:"Hello!",time:"9:32"},{type:2,text:"Hi!",time:"9:33"}]),r=e.ref(""),u=e.ref(!1),x=e.ref(null);e.ref("");let a=!1;const c=e.ref(null),I=e.ref({}),g=e.ref(0),m=e.ref("");e.onLoad(o=>{c.value=o.chatRoomId,D()});const D=async()=>{try{const o=await O.getUserInfoAPI();o&&o.data&&o.data.username?(m.value=o.data.username,e.index.setStorageSync("username",o.data.username),console.log("获取到的用户名:",m.value)):console.error("获取用户信息失败或用户名为空")}catch(o){console.error("获取用户名出错:",o)}};e.onMounted(()=>{console.log("聊天室ID:",c.value),console.log("当前用户名:",m.value),c.value?(A(),z(),y(),v(),L()):e.index.showToast({title:"聊天室ID不存在",icon:"none"})});const _=()=>{u.value=!u.value,u.value&&setTimeout(()=>{f()},300)},A=()=>{I.value={name:"对一题就队",icon:"../../static/images/队伍图标2.jpg"}},z=async()=>{try{if(!c.value)return;const o=await T.getUnreadCount([c.value]);if(o.code===200&&o.data){const s=o.data.find(n=>n.chatRoomId===parseInt(c.value));s&&(g.value=s.count)}}catch(o){console.error("获取未读消息数量失败:",o)}},L=async()=>{try{if(!c.value)return;(await T.markMessagesAsRead(c.value)).code===200&&(g.value=0)}catch(o){console.error("标记消息为已读失败:",o)}};e.onUnmounted(()=>{W()});const y=()=>{try{const o=e.index.getStorageSync("token"),s=`ws://117.72.54.182:8898/chat/${c.value}`;if(a){console.log("WebSocket已连接，无需重新连接");return}e.index.connectSocket({url:s,success:()=>{console.log("WebSocket连接请求发送成功")},fail:n=>{console.error("WebSocket连接请求失败:",n)}}),e.index.onSocketOpen(function(){console.log("WebSocket连接已打开"),a=!0}),e.index.onSocketError(function(n){console.error("WebSocket连接错误:",n),a=!1,e.index.showToast({title:"WebSocket连接失败",icon:"none"}),setTimeout(()=>{a||(console.log("尝试重新连接WebSocket"),y())},5e3)}),e.index.onSocketMessage(function(n){try{const t=JSON.parse(n.data);if(console.log("收到消息:",t),t.messageType){const d=t.messageType==="img";let l="";if(t.sendTime){const h=t.sendTime.match(/\d{2}:\d{2}:\d{2}/);h?l=h[0].substring(0,5):l=new Date().toLocaleTimeString("zh-CN",{hour12:!1}).slice(0,5)}else l=new Date().toLocaleTimeString("zh-CN",{hour12:!1}).slice(0,5);const k=m.value||e.index.getStorageSync("username");console.log("消息判断使用的用户名:",k,"消息中的用户名:",t.username);const S={type:t.username===k?2:1,text:t.content,time:l,isImage:d};i.value.some(h=>h.text===S.text&&h.type===S.type&&h.time===S.time)||(i.value.push(S),f())}}catch(t){console.error("解析消息失败:",t)}}),e.index.onSocketClose(function(){console.log("WebSocket连接已关闭"),a=!1,setTimeout(()=>{a||(console.log("连接已关闭，尝试重新连接"),y())},3e3)}),M()}catch(o){console.error("初始化WebSocket失败:",o)}};let p=null;const M=()=>{p&&clearInterval(p),p=setInterval(()=>{a?(console.log("发送心跳包"),e.index.sendSocketMessage({data:JSON.stringify({type:"heartbeat",chatRoomId:c.value}),fail:o=>{console.error("心跳发送失败:",o),a=!1,clearInterval(p),setTimeout(()=>{y()},1e3)}})):(console.log("WebSocket未连接，尝试重连"),clearInterval(p),y())},3e4)},W=()=>{try{a&&e.index.closeSocket({success:()=>{console.log("WebSocket关闭成功"),a=!1},fail:o=>{console.error("WebSocket关闭失败:",o)},complete:()=>{a=!1,p&&(clearInterval(p),p=null)}})}catch(o){console.error("关闭WebSocket出错:",o)}},v=async()=>{try{const o=await T.getChatMessages(c.value);if(o&&o.code===200&&o.data){i.value=[];const s=m.value||e.index.getStorageSync("username");console.log("历史消息判断使用的用户名:",s),o.data.forEach(n=>{let t="";if(n.sendTime){const l=n.sendTime.match(/\d{2}:\d{2}:\d{2}/);l?t=l[0].substring(0,5):t=new Date(n.timestamp).toLocaleTimeString("zh-CN",{hour12:!1}).slice(0,5)}else t=new Date(n.timestamp).toLocaleTimeString("zh-CN",{hour12:!1}).slice(0,5);const d=n.messageType==="img";i.value.push({type:n.username===s?2:1,text:n.content,time:t,isImage:d})}),f()}}catch(o){console.error("获取历史消息失败:",o),e.index.showToast({title:"获取历史消息失败",icon:"none"})}},f=()=>{setTimeout(()=>{const o=e.index.createSelectorQuery();o.select(".chat-content").boundingClientRect(),o.exec(function(s){s&&s[0]&&e.index.pageScrollTo({scrollTop:s[0].height,duration:300})})},100)},N=()=>{if(r.value.trim()){const o=new Date().toLocaleTimeString("zh-CN",{hour12:!1}).slice(0,5),s={messageType:"text",content:r.value,username:m.value||e.index.getStorageSync("username")};console.log("发送消息:",JSON.stringify(s)),e.index.sendSocketMessage({data:JSON.stringify(s),success:()=>{const n={type:2,text:r.value,time:o,isImage:!1};i.value.push(n),r.value="",f(),setTimeout(()=>{v()},1e3)},fail:n=>{console.error("发送消息失败:",n),e.index.showToast({title:"发送消息失败",icon:"none"})}})}},B=()=>{const o="我的微信是: yangbaba",s=new Date().toLocaleTimeString("zh-CN",{hour12:!1}).slice(0,5),n={messageType:"text",content:o,username:m.value||e.index.getStorageSync("username")};e.index.sendSocketMessage({data:JSON.stringify(n),success:()=>{i.value.push({type:2,text:o,time:s}),f(),setTimeout(()=>{v()},1e3)}})},F=()=>{e.index.chooseImage({count:1,sizeType:["compressed"],sourceType:["album"],success:o=>{const s=o.tempFilePaths[0],n=new Date().toLocaleTimeString("zh-CN",{hour12:!1}).slice(0,5);e.index.showLoading({title:"图片上传中..."}),T.uploadFile(s).then(t=>{if(t.code===200){const d=t.data.url,l={messageType:"img",content:d,username:m.value||e.index.getStorageSync("username")};e.index.sendSocketMessage({data:JSON.stringify(l),success:()=>{i.value.push({type:2,text:d,time:n,isImage:!0}),f(),setTimeout(()=>{v()},1e3)}})}else e.index.showToast({title:"图片上传失败: "+(t.msg||"未知错误"),icon:"none"})}).catch(t=>{console.error("上传图片失败:",t),e.index.showToast({title:"图片上传失败",icon:"none"})}).finally(()=>{e.index.hideLoading()}),u.value=!1}})};return(o,s)=>e.e({a:e.t(I.value.name||"对一题就队"),b:I.value.icon||"../../static/images/队伍图标2.jpg",c:g.value>0},g.value>0?{d:e.t(g.value>99?"99+":g.value)}:{},{e:o.showAnnouncementBar},o.showAnnouncementBar?e.e({f:e.p({type:"volume-up",size:"28",color:"#AC33C1"}),g:e.t(o.announcement||"暂无群公告"),h:o.isLeader},o.isLeader?{i:e.p({type:"compose",size:"24",color:"#888"}),j:e.o((...n)=>o.openAnnouncementDialog&&o.openAnnouncementDialog(...n))}:{},{k:e.o(n=>o.showAnnouncementBar=!1),l:e.p({type:"closeempty",size:"28"})}):{},{m:e.p({name:"fade"}),n:e.f(i.value,(n,t,d)=>e.e({a:n.type==1},n.type==1?{b:C._imports_1$1,c:e.t(n.text),d:e.t(n.time)}:{},{e:n.type==2},n.type==2?e.e({f:!n.isImage},n.isImage?{i:n.text,j:e.o(l=>o.previewImage(n.text),t),k:e.t(n.time)}:{g:e.t(n.text),h:e.t(n.time)},{l:C._imports_1$2}):{},{m:t})),o:u.value?1:"",p:w.value,q:e.o((...n)=>o.onScrollToLower&&o.onScrollToLower(...n)),r:e.o([n=>r.value=n.detail.value,(...n)=>o.handleInput&&o.handleInput(...n)]),s:r.value,t:e.o(_),v:!r.value,w:e.p({type:"plus",size:"40"}),x:r.value,y:e.o(N),z:e.p({type:"image",size:"40"}),A:e.o(F),B:e.p({type:"camera",size:"40"}),C:e.p({type:"email",size:"40"}),D:e.p({type:"phone",size:"40"}),E:e.p({type:"location",size:"40"}),F:e.p({type:"weixin",size:"40"}),G:e.o((...n)=>o.exchangeWechat&&o.exchangeWechat(...n)),H:e.p({type:"mail-open",size:"40"}),I:e.o((...n)=>o.showAnnouncementDialog&&o.showAnnouncementDialog(...n)),J:u.value,K:e.p({name:"slide-up"}),L:u.value?1:"",M:e.o(B),N:e.p({type:"success",cancelText:"取消",confirmText:"确定",content:"您确定要交换联系方式吗?"}),O:e.sr(x,"9b186cfb-14",{k:"isOpen"}),P:e.p({type:"dialog"}),Q:e.o(o.onAnnouncementConfirm),R:e.o(o.onAnnouncementInput),S:e.p({type:o.isLeader?"info":"success",title:o.isLeader?"编辑群公告":"群公告",mode:o.isLeader?"input":"base",value:o.announcementEdit,content:o.isLeader?"":o.announcement||"暂无群公告",placeholder:"请输入群公告内容",showCancelButton:o.isLeader,cancelText:"取消",confirmText:"确定"}),T:e.sr("announcementPopup","9b186cfb-16"),U:e.p({type:"dialog"})})}},J=e._export_sfc(E,[["__scopeId","data-v-9b186cfb"]]);wx.createPage(J);
